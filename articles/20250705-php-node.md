---
title: "php-node で PHP スクリプトを実行する"
emoji: "🔗"
type: "tech"
topics: ["rust", "nodejs", "php"]
published: false
---


序文
----

php-node は PHP スクリプトを Node.js アプリの一部として実行できるようにするツールです。
サーバーサイドの Node.js アプリを新規開発しながら既存のプロジェクトの PHP スクリプトを流用することができます。
開発用途のための HTTP/2 + TLS サーバーのコマンドツールを作ることもできます。
php-node の開発には Rust の napi-rs と ext-php-rs が使われています。


環境
-----

Debian 12 で動作を確認しました。php-node パッケージには libphp.so が付属するため、システムに PHP をインストールする必要はありませんが、
PHP および拡張モジュールが依存するライブラリをインストールする必要があります。Debian の場合、次のモジュールをインストールする必要がありました。


```
sudo apt-get install -y libssl-dev libcurl4-openssl-dev libxml2-dev \
  libsqlite3-dev libonig-dev re2c
```

PHP の制約
----------

PHP スクリプトは Node.js の一部として動くのでシングルスレッドであることが要求されます。PHP ビルトインサーバーや php-fpm で動く PHP スクリプトでもシングルスレッドが要求されるので、多くのフレームワークやCMSは利用できます。

比較対象
--------

Node.js プロジェクトの比較対象として FastCGI プロトコルで php-fpm と通信して PHP スクリプトを実行させるモジュール (fastcgi-client) が挙げられます。
FastCGI と比べると通信量が減るので、パフォーマンスが改善されます。

別の比較対象として Rust の axum などのフレームワークで開発した PHP 拡張による HTTP サーバーやフレームワークを挙げることができます。
Rust と比べると Node.js のフレームワークやミドルウェアは充実しています。

プロジェクトの作成
-----------------

```
npm init -y
npm install @platformatic/php-node
```

ES モジュール方式で利用するために `package.json` の `type` の値を `commonjs` から `module` に変更します。


CLI からの実行
--------------

コマンドライン引数で指定した PHP スクリプトを実行する JS スクリプトを作成します。

```js:cli.js
import { Php, Request } from '@platformatic/php-node';
import path from 'path';
import fs from 'fs';

const phpScript = process.argv[2];

if (!phpScript) {
  console.error('Usage: node cli.js <php-script>');
  process.exit(1);
}

// ファイル存在チェック（カレントディレクトリ以外も可）
const absPath = path.isAbsolute(phpScript) ? phpScript : path.resolve(process.cwd(), phpScript);
if (!fs.existsSync(absPath)) {
  console.error(`File not found: ${absPath}`);
  process.exit(1);
}

const php = new Php({
  argv: process.argv,
  docroot: path.dirname(absPath)  // スクリプトのあるディレクトリをdocrootに
});

// URL の path 部分のみを指定
const url = 'http://localhost/' + path.basename(absPath);

const request = new Request({
  url
});

const response = await php.handleRequest(request);

console.log(response.body.toString());
```

Node.js でリクエストとレスポンスオブジェクトを作成していますが、PHP スクリプトの実行には HTTP サーバーは不要です。
URL の `localhost` は `example.com` など別の文字列でもコードは動きます。
スーパーグローバル変数を生成するために URL の情報が必要になります。


```php:test.php
<?php

echo "Hello World!";
```

次のコマンドを入力すれば `Hello World!` が表示されます。

```
node cli.js test.php
```


スーパーグローバル変数が定義されているか調べてみます。

```php:test.php
<?php

echo $_SERVER['REQUEST_URI'], PHP_EOL;
```

`node cli.js test.php` の実行結果は `/test.php` になります。

php-node に組み込みの PHP を調べる
----------------------------------

test.php を修正します。

```php:test.php
<?php

echo phpversion(), PHP_EOL;
echo php_sapi_name();
```

実行結果は次のようになります。

```
8.4.10-dev
php_lang_handler
```

HTTP サーバー経由で PHP を実行する
-----------------------------------

HTTP/1 サーバーの JS スクリプトおよび PHP スクリプトを用意します。

```js:server.js
import { Php, Request } from '@platformatic/php-node';
import http from 'node:http';
import fs from 'fs';
import path from 'path';
import process from 'process';

const args = process.argv.slice(2);
const port = Number(args[0]) || 8080;
const docroot = args[1] ? path.resolve(args[1]) : process.cwd();

if (!fs.existsSync(docroot)) {
  console.error('指定されたドキュメントルートが存在しません:', docroot);
  process.exit(1);
}

const php = new Php({ docroot });

const server = http.createServer((req, res) => {
  let bodyData = Buffer.alloc(0);
  req.on('data', chunk => {
    bodyData = Buffer.concat([bodyData, chunk]);
  });

  req.on('end', async () => {
    const request = new Request({
      url: `http://localhost${req.url}`,
      method: req.method,
      headers: req.headers,
      body: bodyData,
    });

    try {
      const response = await php.handleRequest(request);

      // ヘッダー設定
      Object.entries(response.headers || {}).forEach(([k, v]) => {
        res.setHeader(k, v);
      });
      // ステータスコード未定義時は200
      res.statusCode = response.statusCode || 200;
      res.end(response.body);
    } catch (err) {
      res.statusCode = 500;
      res.end('Internal Server Error');
      console.error(err);
    }
  });
});

server.listen(port, () => {
  console.log(`php-node HTTP/1.1 サーバー起動: http://localhost:${port}/`);
  console.log('ドキュメントルート:', docroot);
});

// グレースフルシャットダウン
process.on('SIGINT', async () => {
  console.log('\nサーバー停止中...');
  server.close(async () => {
    try {
      await php.close();
      console.log('グレースフルシャットダウン完了。');
      process.exit(0);
    } catch (err) {
      console.error('php.close()失敗:', err);
      process.exit(1);
    }
  });
});

```

通常の Node.js との違いは `php.close()` を実行して PHP のワーカースレッド（MainThread）を停止させる必要があることです。
`ps` コマンドを実行すれば MainThread の存在を確認できます。

```
PID TTY          TIME CMD
10865 pts/1    00:00:00 bash
15253 pts/1    00:00:00 MainThread
15296 pts/1    00:00:00 ps 
```

停止には kill コマンドを使います。

SIGTERM
```
kill 15253
```

SIGKILL
```
kill -9 15253
```


public フォルダーに index.php と json.php を設置します。

```php:index.php
<?php

echo "Hello";
```

```php:json.php
<?php

echo json_encode($_POST);
```


サーバーを起動させます。

```sh
node server.js 8080 ./public
```

curl で正常に動くか確認します。


```
curl -v http://localhost:8080/
```

```
curl -v --data-urlencode 'emoji=🐘' http://localhost:8080/json.php
```

HTTP サーバーコマンドを作成する
--------------------------------


汎用の HTTP サーバーを起動させるコマンドツールを作成することができます。次のように bin フォルダーにコマンドツールとして使いたいスクリプトを設置します。


```
package.json
bin/phpnode-server.js
```

スクリプトの冒頭には `#!/usr/bin/env node` を記載します。インストールするためには次のコマンドを実行します。


```
npm install -g .
```

詳細なコードは [Gist](https://gist.github.com/masakielastic/44f2a6d84f861d2c4e9d3f02f63c3bdc) に公開しておきます。



---